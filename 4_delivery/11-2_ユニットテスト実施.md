---
name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿæ–½ï¼ˆpytestå®Ÿè¡Œãƒ»ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šï¼‰
---

# 11-2 : ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿæ–½ï¼ˆAIPMãƒãƒƒã‚«ã‚½ãƒ³ï¼‰- pytestå®Ÿè¡Œã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

## å‰æ
- `11_QAå®Ÿè¡Œ` ã§ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒã‚¹ã‚¿ãƒ¼ãƒ—ãƒ©ãƒ³ãƒ»ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆæ¸ˆã¿
- pytestã€pytest-cov ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
- ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒ `Flow/{{today}}/{{flow_dir}}/11_QAå®Ÿè¡Œ/unit_tests/` ã«é…ç½®æ¸ˆã¿
- **ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™: 80%ä»¥ä¸Š**

## ç›®çš„
- pytestã‚’å®Ÿè¡Œã—ã¦ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½
- ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆHTMLãƒ»JSONãƒ»ã‚¿ãƒ¼ãƒŸãƒŠãƒ«è¡¨ç¤ºï¼‰
- å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚’ç‰¹å®šã—ã€ä¿®æ­£ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè¡Œ
- ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ã‚’è‡ªå‹•ç”Ÿæˆ

## å®Ÿè¡Œæ‰‹é †
```yaml
- trigger: "(ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿæ–½|å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ|pytestå®Ÿè¡Œ|Run Unit Tests)"
  priority: high
  steps:
    # ========================================
    # Phase 0: ç’°å¢ƒç¢ºèªãƒ»æº–å‚™
    # ========================================
    - name: "check_test_environment"
      action: "execute_shell"
      command: |
        python --version && \
        pytest --version && \
        pytest --cov --version
      message: "ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’ç¢ºèªã—ã¦ã„ã¾ã™..."
      store_as: "env_check"
    
    - name: "display_environment_status"
      action: "display"
      content: |
        ğŸ”§ ãƒ†ã‚¹ãƒˆç’°å¢ƒ
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        {{env_check}}
        
        **ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**:
        `Flow/{{today}}/{{flow_dir}}/11_QAå®Ÿè¡Œ/unit_tests/`
        
        **ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™**: 80%ä»¥ä¸Š
        **ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›å…ˆ**: `Flow/{{today}}/{{flow_dir}}/11_QAå®Ÿè¡Œ/test_reports/`
    
    - name: "load_test_plan"
      action: "analyze"
      data: [
        "{{read_files(find_files(patterns=['**/11_QAå®Ÿè¡Œ/unit_test_master_plan.md']))}}",
        "{{list_files('Flow/{{today}}/{{flow_dir}}/11_QAå®Ÿè¡Œ/unit_tests/', '*.py')}}"
      ]
      instructions: |
        ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒã‚¹ã‚¿ãƒ¼ãƒ—ãƒ©ãƒ³ã‹ã‚‰ä»¥ä¸‹ã‚’æŠ½å‡ºï¼š
        1. ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼ˆtest_*.pyï¼‰
        2. ç·ãƒ†ã‚¹ãƒˆæ•°ã®æ¨å®š
        3. å®Ÿè¡Œé †åºï¼ˆä¾å­˜é–¢ä¿‚è€ƒæ…®ï¼‰
        4. ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™
        5. ãƒ¢ãƒƒã‚¯æˆ¦ç•¥
        
        ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿåœ¨ã‚‚ç¢ºèªã—ã€å­˜åœ¨ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°è­¦å‘Šã€‚
      store_as: "test_plan"
    
    - name: "display_test_overview"
      action: "display"
      content: |
        ğŸ“Š ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œè¨ˆç”»
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ•°**: {{test_plan.test_files_count}}ä»¶
        **æ¨å®šãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ•°**: {{test_plan.estimated_tests}}ä»¶
        **ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™**: {{test_plan.coverage_target}}%
        
        **å®Ÿè¡Œé †åº**ï¼ˆä¾å­˜é–¢ä¿‚è€ƒæ…®ï¼‰:
        {{#each test_plan.execution_order}}
        {{@index}}. {{file}} - {{description}}
        {{/each}}
        
        **æ³¨æ„äº‹é …**:
        - Notion APIã¯ãƒ¢ãƒƒã‚¯åŒ–ã•ã‚Œã¾ã™
        - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯ tempfile ã‚’ä½¿ç”¨ã—ã¾ã™
        - ç’°å¢ƒå¤‰æ•°ã¯ monkeypatch ã§è¨­å®šã—ã¾ã™
    
    - name: "confirm_test_execution"
      action: "confirm"
      message: |
        pytestã‚’å®Ÿè¡Œã—ã¦ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ
        
        å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰:
        pytest unit_tests/ -v --cov=../../dev --cov-report=html --cov-report=term --cov-report=json --junitxml=test_reports/junit.xml
    
    # ========================================
    # Phase 1: pytestå®Ÿè¡Œï¼ˆåˆå›ï¼‰
    # ========================================
    - name: "execute_pytest_initial"
      action: "execute_shell"
      command: |
        cd "Flow/{{today}}/{{flow_dir}}/11_QAå®Ÿè¡Œ" && \
        mkdir -p test_reports && \
        pytest unit_tests/ -v \
          --cov=../../dev \
          --cov-report=html:test_reports/coverage_html \
          --cov-report=term-missing \
          --cov-report=json:test_reports/coverage.json \
          --junitxml=test_reports/junit.xml \
          --tb=short 2>&1 | tee test_reports/pytest_output.log
      message: "pytestå®Ÿè¡Œä¸­ï¼ˆåˆå›ï¼‰..."
      timeout: 300000
      store_as: "pytest_result_initial"
      on_error: "continue"
    
    - name: "parse_pytest_results"
      action: "analyze"
      data: [
        "{{pytest_result_initial}}",
        "{{read_files(find_files(patterns=['**/test_reports/coverage.json']))}}"
      ]
      instructions: |
        pytestå®Ÿè¡Œçµæœã‚’è§£æã—ã€ä»¥ä¸‹ã‚’æŠ½å‡ºï¼š
        1. ç·ãƒ†ã‚¹ãƒˆæ•°ã€æˆåŠŸæ•°ã€å¤±æ•—æ•°ã€ã‚¹ã‚­ãƒƒãƒ—æ•°
        2. å®Ÿè¡Œæ™‚é–“
        3. ã‚«ãƒãƒ¬ãƒƒã‚¸ç‡ï¼ˆå…¨ä½“ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¥ï¼‰
        4. å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®è©³ç´°ï¼ˆãƒ†ã‚¹ãƒˆåãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«åãƒ»è¡Œç•ªå·ï¼‰
        5. ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™ï¼ˆ80%ï¼‰ã«å¯¾ã™ã‚‹é”æˆçŠ¶æ³
        6. ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒä¸è¶³ã—ã¦ã„ã‚‹ç®‡æ‰€ï¼ˆæœªãƒ†ã‚¹ãƒˆé–¢æ•°ãƒ»æœªåˆ°é”è¡Œï¼‰
        
        JSONå½¢å¼ã§è¿”ã™: {"summary": {...}, "failures": [...], "coverage": {...}, "missing_coverage": [...]}
      store_as: "test_results"
    
    - name: "display_initial_results"
      action: "display"
      content: |
        ğŸ“ˆ pytestå®Ÿè¡Œçµæœï¼ˆåˆå›ï¼‰
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        **ã‚µãƒãƒªãƒ¼**:
        - ç·ãƒ†ã‚¹ãƒˆæ•°: {{test_results.summary.total_tests}}ä»¶
        - âœ… æˆåŠŸ: {{test_results.summary.passed}}ä»¶
        - âŒ å¤±æ•—: {{test_results.summary.failed}}ä»¶
        - â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: {{test_results.summary.skipped}}ä»¶
        - â±ï¸ å®Ÿè¡Œæ™‚é–“: {{test_results.summary.duration}}ç§’
        
        **ã‚«ãƒãƒ¬ãƒƒã‚¸**:
        - å…¨ä½“: {{test_results.coverage.total}}% {{#if test_results.coverage.meets_goal}}âœ… ç›®æ¨™é”æˆ{{else}}âš ï¸ ç›®æ¨™æœªé”ï¼ˆ80%ï¼‰{{/if}}
        
        **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¥ã‚«ãƒãƒ¬ãƒƒã‚¸**:
        {{#each test_results.coverage.by_module}}
        - {{module_name}}: {{coverage}}%
        {{/each}}
        
        {{#if test_results.failures}}
        **å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆ**:
        {{#each test_results.failures}}
        - {{test_name}} ({{file}}:{{line}})
          ã‚¨ãƒ©ãƒ¼: {{error_message}}
        {{/each}}
        {{/if}}
        
        **ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ**:
        - HTML: `test_reports/coverage_html/index.html` ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦è©³ç´°ç¢ºèª
        - JSON: `test_reports/coverage.json`
        - JUnit XML: `test_reports/junit.xml`
    
    # ========================================
    # Phase 2: å¤±æ•—ãƒ†ã‚¹ãƒˆä¿®æ­£ãƒ«ãƒ¼ãƒ—
    # ========================================
    - name: "check_if_fixes_needed"
      action: "conditional"
      condition: "{{test_results.summary.failed > 0}}"
      if_true: "proceed_to_fix_loop"
      if_false: "skip_to_coverage_check"
    
    - name: "proceed_to_fix_loop"
      action: "display"
      content: |
        ğŸ”§ å¤±æ•—ãƒ†ã‚¹ãƒˆä¿®æ­£ãƒ«ãƒ¼ãƒ—
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        {{test_results.summary.failed}}ä»¶ã®å¤±æ•—ãƒ†ã‚¹ãƒˆã‚’ä¿®æ­£ã—ã¾ã™ã€‚
    
    - name: "analyze_failures_and_suggest_fixes"
      action: "analyze"
      data: [
        "{{test_results.failures}}",
        "{{read_files(find_files(patterns=['**/unit_tests/*.py']))}}"
      ]
      instructions: |
        å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆå„ä»¶ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã‚’åˆ†æï¼š
        1. å¤±æ•—ç†ç”±ã®ç‰¹å®šï¼ˆã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—ãƒ»ä¾‹å¤–ç™ºç”Ÿãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãªã©ï¼‰
        2. åŸå› ã®æ¨å®šï¼ˆãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®èª¤ã‚Šãƒ»ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚³ãƒ¼ãƒ‰ã®ä¸å…·åˆãƒ»ãƒ¢ãƒƒã‚¯è¨­å®šãƒŸã‚¹ãªã©ï¼‰
        3. ä¿®æ­£æ¡ˆã®æç¤ºï¼ˆãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¿®æ­£ãƒ»æœ¬ä½“ã‚³ãƒ¼ãƒ‰ä¿®æ­£ãƒ»ãƒ¢ãƒƒã‚¯è¿½åŠ ãªã©ï¼‰
        4. å„ªå…ˆé †ä½ï¼ˆã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ»é«˜ãƒ»ä¸­ãƒ»ä½ï¼‰
        
        ä¿®æ­£å¯èƒ½ãªã‚‚ã®ã¯å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’æç¤ºã€‚
        JSONå½¢å¼ã§è¿”ã™: {"fixes": [{"test_name": "...", "reason": "...", "fix_type": "...", "priority": "...", "code_diff": "..."}, ...]}
      store_as: "fix_suggestions"
    
    - name: "display_fix_suggestions"
      action: "display"
      content: |
        ğŸ’¡ ä¿®æ­£ææ¡ˆ
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        {{#each fix_suggestions.fixes}}
        ### {{@index}}. {{test_name}} (å„ªå…ˆåº¦: {{priority}})
        
        **å¤±æ•—ç†ç”±**: {{reason}}
        **ä¿®æ­£ã‚¿ã‚¤ãƒ—**: {{fix_type}}
        
        **ä¿®æ­£æ¡ˆ**:
        ```{{code_language}}
        {{code_diff}}
        ```
        
        ---
        {{/each}}
    
    - name: "confirm_apply_fixes"
      action: "confirm"
      message: |
        ä¸Šè¨˜ã®ä¿®æ­£æ¡ˆã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ
        
        ä¿®æ­£å¯¾è±¡: {{fix_suggestions.fixes.length}}ä»¶
        - ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¿®æ­£: {{fix_suggestions.test_code_fixes}}ä»¶
        - æœ¬ä½“ã‚³ãƒ¼ãƒ‰ä¿®æ­£: {{fix_suggestions.source_code_fixes}}ä»¶
        - ãƒ¢ãƒƒã‚¯è¿½åŠ : {{fix_suggestions.mock_additions}}ä»¶
    
    - name: "apply_fixes"
      action: "apply_code_changes"
      changes: "{{fix_suggestions.fixes}}"
      message: "ä¿®æ­£ã‚’é©ç”¨ã—ã¦ã„ã¾ã™..."
    
    - name: "record_fixes"
      action: "create_markdown_file"
      path: "Flow/{{today}}/{{flow_dir}}/11_QAå®Ÿè¡Œ/test_reports/fix_log_{{timestamp}}.md"
      content: |
        # ãƒ†ã‚¹ãƒˆä¿®æ­£ãƒ­ã‚° {{timestamp}}
        
        ## ä¿®æ­£å†…å®¹
        {{#each fix_suggestions.fixes}}
        ### {{test_name}}
        - **å¤±æ•—ç†ç”±**: {{reason}}
        - **ä¿®æ­£ã‚¿ã‚¤ãƒ—**: {{fix_type}}
        - **å„ªå…ˆåº¦**: {{priority}}
        - **ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: {{file}}
        
        **é©ç”¨ã—ãŸä¿®æ­£**:
        ```{{code_language}}
        {{code_diff}}
        ```
        
        ---
        {{/each}}
    
    - name: "rerun_pytest_after_fixes"
      action: "execute_shell"
      command: |
        cd "Flow/{{today}}/{{flow_dir}}/11_QAå®Ÿè¡Œ" && \
        pytest unit_tests/ -v \
          --cov=../../dev \
          --cov-report=html:test_reports/coverage_html \
          --cov-report=term-missing \
          --cov-report=json:test_reports/coverage.json \
          --junitxml=test_reports/junit.xml \
          --tb=short 2>&1 | tee test_reports/pytest_output_after_fix.log
      message: "pytestå†å®Ÿè¡Œä¸­ï¼ˆä¿®æ­£å¾Œï¼‰..."
      timeout: 300000
      store_as: "pytest_result_after_fix"
      on_error: "continue"
    
    - name: "parse_rerun_results"
      action: "analyze"
      data: [
        "{{pytest_result_after_fix}}",
        "{{read_files(find_files(patterns=['**/test_reports/coverage.json']))}}"
      ]
      instructions: |
        ä¿®æ­£å¾Œã®pytestå®Ÿè¡Œçµæœã‚’è§£æã—ã€åˆå›çµæœã¨æ¯”è¼ƒï¼š
        1. æ”¹å–„ã•ã‚ŒãŸå¤±æ•—ãƒ†ã‚¹ãƒˆæ•°
        2. æ®‹å­˜ã™ã‚‹å¤±æ•—ãƒ†ã‚¹ãƒˆ
        3. ã‚«ãƒãƒ¬ãƒƒã‚¸ã®å¤‰åŒ–
        4. æ–°ãŸã«ç™ºç”Ÿã—ãŸå•é¡Œï¼ˆãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ï¼‰
        
        JSONå½¢å¼ã§è¿”ã™: {"summary": {...}, "comparison": {...}, "remaining_failures": [...]}
      store_as: "rerun_results"
    
    - name: "display_rerun_comparison"
      action: "display"
      content: |
        ğŸ“Š ä¿®æ­£å¾Œã®çµæœæ¯”è¼ƒ
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        **æ”¹å–„çŠ¶æ³**:
        - åˆå›å¤±æ•—: {{test_results.summary.failed}}ä»¶
        - ä¿®æ­£å¾Œå¤±æ•—: {{rerun_results.summary.failed}}ä»¶
        - æ”¹å–„: {{rerun_results.comparison.fixed_tests}}ä»¶ âœ…
        
        {{#if rerun_results.remaining_failures}}
        **æ®‹å­˜ã™ã‚‹å¤±æ•—**:
        {{#each rerun_results.remaining_failures}}
        - {{test_name}}: {{error_message}}
        {{/each}}
        {{/if}}
        
        **ã‚«ãƒãƒ¬ãƒƒã‚¸å¤‰åŒ–**:
        - åˆå›: {{test_results.coverage.total}}%
        - ä¿®æ­£å¾Œ: {{rerun_results.coverage.total}}% ({{rerun_results.comparison.coverage_change}}%)
    
    - name: "check_if_more_fixes_needed"
      action: "conditional"
      condition: "{{rerun_results.summary.failed > 0}}"
      if_true: "ask_continue_fix_loop"
      if_false: "proceed_to_coverage_check"
    
    - name: "ask_continue_fix_loop"
      action: "confirm"
      message: |
        ã¾ã  {{rerun_results.summary.failed}}ä»¶ã®å¤±æ•—ãƒ†ã‚¹ãƒˆãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚
        
        ä¿®æ­£ãƒ«ãƒ¼ãƒ—ã‚’ç¶šã‘ã¾ã™ã‹ï¼Ÿï¼ˆæœ€å¤§3å›ã¾ã§ï¼‰
      store_as: "continue_fix_loop"
    
    - name: "repeat_fix_loop"
      action: "conditional"
      condition: "{{continue_fix_loop && fix_loop_count < 3}}"
      if_true: "analyze_failures_and_suggest_fixes"
      if_false: "proceed_to_coverage_check"
    
    # ========================================
    # Phase 3: ã‚«ãƒãƒ¬ãƒƒã‚¸ä¸è¶³ç®‡æ‰€ã®è£œå®Œ
    # ========================================
    - name: "skip_to_coverage_check"
      action: "display"
      content: "å…¨ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸã€‚ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèªã«é€²ã¿ã¾ã™ã€‚"
    
    - name: "proceed_to_coverage_check"
      action: "analyze"
      data: [
        "{{read_files(find_files(patterns=['**/test_reports/coverage.json']))}}",
        "{{read_files(find_files(patterns=['**/unit_test_master_plan.md']))}}"
      ]
      instructions: |
        ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’è§£æã—ã€80%ç›®æ¨™ã«å¯¾ã™ã‚‹ä¸è¶³ç®‡æ‰€ã‚’ç‰¹å®šï¼š
        1. ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ80%æœªæº€ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
        2. æœªãƒ†ã‚¹ãƒˆã®é–¢æ•°
        3. åˆ°é”ã—ã¦ã„ãªã„ã‚³ãƒ¼ãƒ‰è¡Œï¼ˆåˆ†å²ãƒ»ä¾‹å¤–å‡¦ç†ãªã©ï¼‰
        4. è¿½åŠ ãƒ†ã‚¹ãƒˆã®å„ªå…ˆé †ä½
        5. æ¨å¥¨ã•ã‚Œã‚‹ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
        
        JSONå½¢å¼ã§è¿”ã™: {"meets_goal": bool, "missing_coverage": [...], "recommended_tests": [...]}
      store_as: "coverage_analysis"
    
    - name: "display_coverage_analysis"
      action: "display"
      content: |
        ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æ
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        **ç›®æ¨™é”æˆçŠ¶æ³**: {{#if coverage_analysis.meets_goal}}âœ… é”æˆï¼ˆ80%ä»¥ä¸Šï¼‰{{else}}âš ï¸ æœªé”æˆï¼ˆ80%æœªæº€ï¼‰{{/if}}
        
        {{#unless coverage_analysis.meets_goal}}
        **ã‚«ãƒãƒ¬ãƒƒã‚¸ä¸è¶³ç®‡æ‰€**:
        {{#each coverage_analysis.missing_coverage}}
        - {{module_name}}: {{coverage}}% (ç›®æ¨™: 80%)
          - æœªãƒ†ã‚¹ãƒˆé–¢æ•°: {{untested_functions}}
          - æœªåˆ°é”è¡Œ: {{uncovered_lines}}
        {{/each}}
        
        **è¿½åŠ æ¨å¥¨ãƒ†ã‚¹ãƒˆ**:
        {{#each coverage_analysis.recommended_tests}}
        {{@index}}. **{{test_name}}** (å„ªå…ˆåº¦: {{priority}})
           - å¯¾è±¡é–¢æ•°: {{target_function}}
           - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹: {{test_cases}}
           - æœŸå¾…ã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Š: +{{coverage_increase}}%
        {{/each}}
        {{/unless}}
    
    - name: "ask_add_coverage_tests"
      action: "conditional"
      condition: "{{!coverage_analysis.meets_goal}}"
      if_true: "confirm_add_coverage_tests"
      if_false: "skip_coverage_tests"
    
    - name: "confirm_add_coverage_tests"
      action: "confirm"
      message: |
        ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™æœªé”æˆã§ã™ã€‚è¿½åŠ ãƒ†ã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ
        
        è¿½åŠ æ¨å¥¨: {{coverage_analysis.recommended_tests.length}}ä»¶
        æœŸå¾…ã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Š: +{{coverage_analysis.total_coverage_increase}}%
      store_as: "add_coverage_tests"
    
    - name: "generate_additional_tests"
      action: "analyze"
      data: [
        "{{coverage_analysis.recommended_tests}}",
        "{{read_files(find_files(patterns=['**/unit_tests/*.py']))}}"
      ]
      instructions: |
        æ¨å¥¨ã•ã‚ŒãŸè¿½åŠ ãƒ†ã‚¹ãƒˆã®å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆï¼š
        1. æ—¢å­˜ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®è¿½è¨˜ã¾ãŸã¯æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        2. ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ»ç•°å¸¸ç³»ã®ç¶²ç¾…
        3. ãƒ¢ãƒƒã‚¯æˆ¦ç•¥ã®ç¶™æ‰¿
        4. æ—¢å­˜ãƒ†ã‚¹ãƒˆã¨ã®æ•´åˆæ€§
        
        JSONå½¢å¼ã§è¿”ã™: {"test_files": [{"path": "...", "content": "...", "description": "..."}, ...]}
      store_as: "additional_tests"
    
    - name: "create_additional_test_files"
      action: "create_or_update_files"
      files: "{{additional_tests.test_files}}"
      base_path: "Flow/{{today}}/{{flow_dir}}/11_QAå®Ÿè¡Œ/unit_tests/"
      message: "è¿½åŠ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã„ã¾ã™..."
    
    - name: "rerun_pytest_with_additional_tests"
      action: "execute_shell"
      command: |
        cd "Flow/{{today}}/{{flow_dir}}/11_QAå®Ÿè¡Œ" && \
        pytest unit_tests/ -v \
          --cov=../../dev \
          --cov-report=html:test_reports/coverage_html \
          --cov-report=term-missing \
          --cov-report=json:test_reports/coverage.json \
          --junitxml=test_reports/junit.xml \
          --tb=short 2>&1 | tee test_reports/pytest_output_final.log
      message: "pytestæœ€çµ‚å®Ÿè¡Œä¸­ï¼ˆè¿½åŠ ãƒ†ã‚¹ãƒˆå«ã‚€ï¼‰..."
      timeout: 300000
      store_as: "pytest_result_final"
    
    - name: "parse_final_results"
      action: "analyze"
      data: [
        "{{pytest_result_final}}",
        "{{read_files(find_files(patterns=['**/test_reports/coverage.json']))}}"
      ]
      instructions: |
        æœ€çµ‚pytestå®Ÿè¡Œçµæœã‚’è§£æï¼š
        1. ç·ãƒ†ã‚¹ãƒˆæ•°ï¼ˆè¿½åŠ å¾Œï¼‰
        2. å…¨ãƒ†ã‚¹ãƒˆã®æˆåŠŸ/å¤±æ•—çŠ¶æ³
        3. æœ€çµ‚ã‚«ãƒãƒ¬ãƒƒã‚¸ç‡
        4. ç›®æ¨™ï¼ˆ80%ï¼‰é”æˆçŠ¶æ³
        
        JSONå½¢å¼ã§è¿”ã™: {"summary": {...}, "coverage": {...}, "goal_achieved": bool}
      store_as: "final_results"
    
    - name: "skip_coverage_tests"
      action: "display"
      content: "ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™é”æˆæ¸ˆã¿ã§ã™ã€‚æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«é€²ã¿ã¾ã™ã€‚"
    
    # ========================================
    # Phase 4: ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ç”Ÿæˆ
    # ========================================
    - name: "generate_test_summary_report"
      action: "create_markdown_file"
      path: "Flow/{{today}}/{{flow_dir}}/11_QAå®Ÿè¡Œ/test_reports/unit_test_summary.md"
      content: |
        # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿæ–½ã‚µãƒãƒªãƒ¼
        
        **å®Ÿè¡Œæ—¥æ™‚**: {{timestamp}}
        **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: {{project_name}}
        **ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™**: 80%
        
        ## æœ€çµ‚çµæœ
        
        ### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚µãƒãƒªãƒ¼
        - **ç·ãƒ†ã‚¹ãƒˆæ•°**: {{final_results.summary.total_tests}}ä»¶
        - **âœ… æˆåŠŸ**: {{final_results.summary.passed}}ä»¶
        - **âŒ å¤±æ•—**: {{final_results.summary.failed}}ä»¶
        - **â­ï¸ ã‚¹ã‚­ãƒƒãƒ—**: {{final_results.summary.skipped}}ä»¶
        - **â±ï¸ å®Ÿè¡Œæ™‚é–“**: {{final_results.summary.duration}}ç§’
        
        ### ã‚«ãƒãƒ¬ãƒƒã‚¸çµæœ
        - **å…¨ä½“ã‚«ãƒãƒ¬ãƒƒã‚¸**: {{final_results.coverage.total}}%
        - **ç›®æ¨™é”æˆ**: {{#if final_results.goal_achieved}}âœ… é”æˆï¼ˆ80%ä»¥ä¸Šï¼‰{{else}}âš ï¸ æœªé”æˆ{{/if}}
        
        **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¥ã‚«ãƒãƒ¬ãƒƒã‚¸**:
        {{#each final_results.coverage.by_module}}
        | {{module_name}} | {{coverage}}% | {{#if meets_goal}}âœ…{{else}}âš ï¸{{/if}} |
        {{/each}}
        
        ## å®Ÿè¡Œå±¥æ­´
        
        ### åˆå›å®Ÿè¡Œ
        - ãƒ†ã‚¹ãƒˆæ•°: {{test_results.summary.total_tests}}ä»¶
        - å¤±æ•—: {{test_results.summary.failed}}ä»¶
        - ã‚«ãƒãƒ¬ãƒƒã‚¸: {{test_results.coverage.total}}%
        
        {{#if fix_suggestions}}
        ### ä¿®æ­£ãƒ«ãƒ¼ãƒ—ï¼ˆ{{fix_loop_count}}å›ï¼‰
        {{#each fix_logs}}
        #### ãƒ«ãƒ¼ãƒ—{{@index}}
        - ä¿®æ­£ä»¶æ•°: {{fixes_applied}}ä»¶
        - æ”¹å–„ãƒ†ã‚¹ãƒˆæ•°: {{fixed_tests}}ä»¶
        - ã‚«ãƒãƒ¬ãƒƒã‚¸å¤‰åŒ–: {{coverage_before}}% â†’ {{coverage_after}}%
        {{/each}}
        {{/if}}
        
        {{#if additional_tests}}
        ### ã‚«ãƒãƒ¬ãƒƒã‚¸è£œå®Œ
        - è¿½åŠ ãƒ†ã‚¹ãƒˆ: {{additional_tests.test_files.length}}ä»¶
        - ã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Š: +{{coverage_increase}}%
        {{/if}}
        
        ## æˆåŠŸåŸºæº–
        - [{{#if final_results.summary.failed == 0}}x{{else}} {{/if}}] å…¨ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ
        - [{{#if final_results.goal_achieved}}x{{else}} {{/if}}] ã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Šé”æˆ
        - [{{#if final_results.summary.duration < 300}}x{{else}} {{/if}}] å®Ÿè¡Œæ™‚é–“5åˆ†ä»¥å†…
        
        ## è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ
        - **HTMLã‚«ãƒãƒ¬ãƒƒã‚¸**: `test_reports/coverage_html/index.html`
        - **JSONã‚«ãƒãƒ¬ãƒƒã‚¸**: `test_reports/coverage.json`
        - **JUnit XML**: `test_reports/junit.xml`
        - **pytestå‡ºåŠ›ãƒ­ã‚°**: `test_reports/pytest_output*.log`
        
        {{#if fix_suggestions}}
        ## ä¿®æ­£ãƒ­ã‚°
        {{#each fix_logs}}
        - `test_reports/fix_log_{{timestamp}}.md`
        {{/each}}
        {{/if}}
        
        ## æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        {{#if final_results.summary.failed > 0}}
        âš ï¸ **å¤±æ•—ãƒ†ã‚¹ãƒˆãŒæ®‹ã£ã¦ã„ã¾ã™**:
        {{#each final_results.failures}}
        - {{test_name}}: {{error_message}}
        {{/each}}
        
        æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:
        1. å¤±æ•—ãƒ†ã‚¹ãƒˆã®åŸå› ã‚’è©³ç´°èª¿æŸ»
        2. æœ¬ä½“ã‚³ãƒ¼ãƒ‰ã¾ãŸã¯ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£
        3. pytestå†å®Ÿè¡Œ
        {{/if}}
        
        {{#unless final_results.goal_achieved}}
        âš ï¸ **ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™æœªé”æˆ**:
        - ç¾åœ¨: {{final_results.coverage.total}}%
        - ç›®æ¨™: 80%
        - ä¸è¶³: {{80 - final_results.coverage.total}}%
        
        æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:
        1. HTMLã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã§æœªåˆ°é”ç®‡æ‰€ã‚’ç¢ºèª
        2. å„ªå…ˆåº¦ã®é«˜ã„é–¢æ•°ãƒ»åˆ†å²ã®ãƒ†ã‚¹ãƒˆè¿½åŠ 
        3. pytestå†å®Ÿè¡Œ
        {{/unless}}
        
        {{#if final_results.goal_achieved && final_results.summary.failed == 0}}
        âœ… **å…¨åŸºæº–é”æˆ**: çµ±åˆãƒ†ã‚¹ãƒˆã«é€²ã‚€ã“ã¨ãŒã§ãã¾ã™
        
        æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:
        1. `11_QAå®Ÿè¡Œ` ã§çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½
        2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½
        3. QAç·åˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        {{/if}}
        
        ## å‚ç…§
        - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒã‚¹ã‚¿ãƒ¼ãƒ—ãƒ©ãƒ³: `../unit_test_master_plan.md`
        - ãƒˆãƒ¼ã‚¿ãƒ«é–‹ç™ºä»•æ§˜æ›¸: `../../07_é–‹ç™ºã‚¿ã‚¹ã‚¯åˆ†è§£/total_development_spec.md`
    
    - name: "display_completion_summary"
      action: "display"
      content: |
        âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿæ–½å®Œäº†
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        **æœ€çµ‚çµæœ**:
        - ç·ãƒ†ã‚¹ãƒˆæ•°: {{final_results.summary.total_tests}}ä»¶
        - æˆåŠŸç‡: {{final_results.summary.success_rate}}%
        - ã‚«ãƒãƒ¬ãƒƒã‚¸: {{final_results.coverage.total}}% {{#if final_results.goal_achieved}}âœ…{{else}}âš ï¸{{/if}}
        
        **ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«**:
        - ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ: `test_reports/unit_test_summary.md`
        - HTMLã‚«ãƒãƒ¬ãƒƒã‚¸: `test_reports/coverage_html/index.html`
        - JUnit XML: `test_reports/junit.xml`
        {{#if fix_suggestions}}
        - ä¿®æ­£ãƒ­ã‚°: `test_reports/fix_log_*.md`
        {{/if}}
        
        **æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:
        {{#if final_results.goal_achieved && final_results.summary.failed == 0}}
        âœ… å…¨åŸºæº–é”æˆ â†’ `11_QAå®Ÿè¡Œ` ã§çµ±åˆãƒ†ã‚¹ãƒˆã«é€²ã‚“ã§ãã ã•ã„
        {{else}}
        âš ï¸ åŸºæº–æœªé”æˆ â†’ ä¸Šè¨˜ã®æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„
        {{/if}}
        
        **ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç¢ºèª**:
        ãƒ–ãƒ©ã‚¦ã‚¶ã§ `test_reports/coverage_html/index.html` ã‚’é–‹ã„ã¦è©³ç´°ç¢ºèªã§ãã¾ã™ã€‚
```

## æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰
â†’ `11_QAå®Ÿè¡Œ` ã§çµ±åˆãƒ†ã‚¹ãƒˆãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã«é€²ã‚€
â†’ `15_ãƒªãƒªãƒ¼ã‚¹åˆ¤å®š` ã§ãƒªãƒªãƒ¼ã‚¹å¯å¦ã‚’ç·åˆè©•ä¾¡

## å¤‰æ›´ç‚¹ï¼ˆv1.0 - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿæ–½ï¼‰
- **pytestè‡ªå‹•å®Ÿè¡Œ**: ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šä»˜ãã§pytestã‚’è‡ªå‹•å®Ÿè¡Œ
- **ä¿®æ­£ãƒ«ãƒ¼ãƒ—**: å¤±æ•—ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•è§£æãƒ»ä¿®æ­£ææ¡ˆãƒ»å†å®Ÿè¡Œï¼ˆæœ€å¤§3å›ï¼‰
- **ã‚«ãƒãƒ¬ãƒƒã‚¸è£œå®Œ**: 80%æœªé”ã®å ´åˆã€è¿½åŠ ãƒ†ã‚¹ãƒˆè‡ªå‹•ç”Ÿæˆ
- **è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ**: HTMLãƒ»JSONãƒ»JUnit XMLãƒ»ã‚¿ãƒ¼ãƒŸãƒŠãƒ«å‡ºåŠ›ã®çµ±åˆ
- **æ®µéšçš„å®Ÿè¡Œ**: åˆå›å®Ÿè¡Œ â†’ ä¿®æ­£ãƒ«ãƒ¼ãƒ— â†’ ã‚«ãƒãƒ¬ãƒƒã‚¸è£œå®Œ â†’ æœ€çµ‚å®Ÿè¡Œ
- **æˆåŠŸåŸºæº–ãƒã‚§ãƒƒã‚¯**: å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸãƒ»ã‚«ãƒãƒ¬ãƒƒã‚¸80%ãƒ»å®Ÿè¡Œæ™‚é–“5åˆ†ã®è‡ªå‹•åˆ¤å®š
