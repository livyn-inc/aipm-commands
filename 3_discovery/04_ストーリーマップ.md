# 04 ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—ï¼ˆè¤‡æ•°ãƒšãƒ«ã‚½ãƒŠãƒ»ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆç‰ˆï¼‰

## å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰
### ğŸš€ **è¤‡æ•°ãƒšãƒ«ã‚½ãƒŠãƒ¢ãƒ¼ãƒ‰**ï¼ˆ4ãƒšãƒ«ã‚½ãƒŠã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒƒãƒ—ãŒã‚ã‚‹å ´åˆï¼‰
4ãƒšãƒ«ã‚½ãƒŠï¼ˆç”°ä¸­ãƒ»ä½è—¤ãƒ»å±±ç”°ãƒ»é«˜æ©‹ï¼‰ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒƒãƒ—ï¼ˆSL001-SL039ï¼‰ã¨Opportunityä»®èª¬ï¼ˆFH001-FH020ï¼‰ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’è‡ªå‹•ç”Ÿæˆã—ã€MVPå„ªå…ˆåº¦ã«åŸºã¥ãã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—ã‚’ä½œæˆ

### ğŸ“ **å˜ä¸€ãƒšãƒ«ã‚½ãƒŠãƒ¢ãƒ¼ãƒ‰**ï¼ˆ1ãƒšãƒ«ã‚½ãƒŠã®ã¿ã®å ´åˆï¼‰
å¾“æ¥ã®è³ªå•å½¢å¼ã§å˜ä¸€ãƒšãƒ«ã‚½ãƒŠã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’åé›†ã—ã€Aâ†’PRâ†’SLâ†’STã®æµã‚Œã§å¯è¦–åŒ–

## è¤‡æ•°ãƒšãƒ«ã‚½ãƒŠãƒ¢ãƒ¼ãƒ‰ - è‡ªå‹•æ¤œå‡ºå¯¾è±¡
- `P001_ç”°ä¸­_é›…äºº/solution_map_P001.yaml` - AIæ¨é€²ãƒªãƒ¼ãƒ€ãƒ¼ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³
- `P002_ä½è—¤_äº‹æ¥­è²¬ä»»è€…/solution_map_P002.yaml` - çµŒå–¶å±¤ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³
- `P003_å±±ç”°_å¥å¤ª/solution_map_P003.yaml` - ç¾å ´PdMã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³
- `P004_é«˜æ©‹_ç¾å’²/solution_map_P004.yaml` - ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é‹ç”¨ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³
- `integrated_solution_map.yaml` - çµ±åˆã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»MVPå„ªå…ˆåº¦
- `focus_opportunity_hypotheses.yaml` - FH001-FH020ä»®èª¬ãƒãƒƒãƒ”ãƒ³ã‚°

## å˜ä¸€ãƒšãƒ«ã‚½ãƒŠãƒ¢ãƒ¼ãƒ‰ - è³ªå•é …ç›®
- ãƒšãƒ«ã‚½ãƒŠï¼ˆæ—¢å®š: P001ï¼‰ï¼ˆå¿…é ˆï¼‰
- PR1/PR2/PR3 ãã‚Œãã‚Œã«å¯¾ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆAs a / I want / So thatï¼‰ï¼ˆå¿…é ˆï¼‰
- å„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®å—ã‘å…¥ã‚ŒåŸºæº–ï¼ˆå¿…é ˆï¼‰
- ãƒªãƒªãƒ¼ã‚¹åŒºåˆ†ï¼ˆMVP or Release1ï¼‰ï¼ˆå¿…é ˆï¼‰
- å®Ÿè£…é †åºï¼ˆä»»æ„ï¼‰

## ç›®çš„
è¤‡æ•°ãƒšãƒ«ã‚½ãƒŠã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆSLï¼‰ã«å¯¾ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆSTï¼‰ã‚’çµ±åˆçš„ã«è¨­è¨ˆã—ã€MVPå„ªå…ˆåº¦ã«åŸºã¥ããƒªãƒªãƒ¼ã‚¹è¨ˆç”»ãƒ»å®Ÿè£…é †åºã‚’æ˜ç¢ºåŒ–ã—ã¾ã™ã€‚Aâ†’PRâ†’SLâ†’STã®å®Œå…¨ãªãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ã€‚

## å®Ÿè¡Œæ‰‹é †
```yaml
- trigger: "(ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—|ä»®èª¬é§†å‹•_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—|HypothesisStoryMap|Story Map)"
  priority: high
  steps:
    # Step 1: ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šï¼ˆè¤‡æ•°ãƒšãƒ«ã‚½ãƒŠã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒƒãƒ—ã®å­˜åœ¨ç¢ºèªï¼‰
    - name: "check_solution_maps"
      action: "analyze"
      data: [
        "{{find_files(patterns=['**/P001_*/solution_map_*.yaml'])}}", 
        "{{find_files(patterns=['**/P002_*/solution_map_*.yaml'])}}", 
        "{{find_files(patterns=['**/P003_*/solution_map_*.yaml'])}}", 
        "{{find_files(patterns=['**/P004_*/solution_map_*.yaml'])}}", 
        "{{find_files(patterns=['**/integrated_solution_map.yaml'])}}"
      ]
      instructions: |
        ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèªçµæœã‹ã‚‰å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ï¼š
        - 3ã¤ä»¥ä¸Šã®ãƒšãƒ«ã‚½ãƒŠã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒƒãƒ— + çµ±åˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨: "multi_persona"
        - ãã‚Œä»¥ä¸‹ã®å ´åˆ: "single_persona"
        
        çµæœã‚’JSONã§è¿”ã—ã¦ãã ã•ã„ï¼š
        {"mode": "multi_persona|single_persona", "found_solution_maps": ["P001", "P002", ...], "has_integrated": true/false}
      store_as: "execution_mode"

    # === è¤‡æ•°ãƒšãƒ«ã‚½ãƒŠãƒ¢ãƒ¼ãƒ‰ ===
    - name: "load_solution_data"
      condition: "{{execution_mode.mode == 'multi_persona'}}"
      action: "analyze"
      data: [
        "{{read_files(find_files(patterns=['**/P001_*/solution_map_*.yaml']))}}",
        "{{read_files(find_files(patterns=['**/P003_*/solution_map_*.yaml']))}}",
        "{{read_files(find_files(patterns=['**/P004_*/solution_map_*.yaml']))}}",
        "{{read_files(find_files(patterns=['**/integrated_solution_map.yaml']))}}",
        "{{read_files(find_files(patterns=['**/focus_opportunity_hypotheses.yaml']))}}"
      ]
      instructions: |
        4ãƒšãƒ«ã‚½ãƒŠã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒƒãƒ—ã¨çµ±åˆã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç”Ÿæˆã—ã€ä»¥ä¸‹ã®æ§‹é€ ã§è¿”ã—ã¦ãã ã•ã„ï¼š
        {
          "project_name": "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆä»»æ„ãªã‚‰ 'Untitled'ï¼‰",
          "activities": [
            {"id":"ACT-ONBOARD","name":"Onboarding"},
            {"id":"ACT-TASKS","name":"Tasks"}
          ],
          "backbones": [
            {"id":"BB-SIGNUP","name":"Sign up","sequence":1,"activity_id":"ACT-ONBOARD"},
            {"id":"BB-FLOW","name":"Create Task","sequence":2,"activity_id":"ACT-TASKS"}
          ],
          "personas": [
            {"key":"P001","name":"ç”°ä¸­ é›…äºº","stories":[{"id":"ST-001","story":"...","backbone_id":"BB-SIGNUP","version":"MVP","status":"TODO"}]} 
          ],
          "cross_persona_stories": [
            {"id":"CST-001","story":"æ¨ªæ–­ã‚¹ãƒˆãƒ¼ãƒªãƒ¼","backbone_id":"BB-FLOW","version":"V1","status":"TODO"}
          ],
          "display_order": ["BB-SIGNUP","BB-FLOW"],
          "story_mapping": {"ST-001": {"backbone_id":"BB-SIGNUP","sequence":1}},
          "traceability": {
            "problem_refs": ["PR1","PR2"],
            "links": [ {"chain": ["A101","PR1","SL1","ST-001"]} ]
          }
        }
      store_as: "multi_persona_stories"

    # === å˜ä¸€ãƒšãƒ«ã‚½ãƒŠãƒ¢ãƒ¼ãƒ‰ ===
    - name: "infer_defaults_from_thread"
      condition: "{{execution_mode.mode == 'single_persona'}}"
      action: "analyze"
      data: ["{{thread_messages}}", "{{read_files(find_files(patterns=['**/solution_map.yaml','**/problem_map.yaml','**/customer_problem_map.yaml']))}}"]
      instructions: |
        ç›´è¿‘ã®PR/SL/Activityå¯¾å¿œã‹ã‚‰ã€PRâ†’SLâ†’STã®åˆæœŸãƒã‚§ãƒ¼ãƒ³ï¼ˆST1/2/3ï¼‰ã‚’æ¨å®šã—ã¦è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
      store_as: "auto_story_hints"

    - name: "ingest_sense_focus"
      action: "analyze"
      data: [
        "{{read_files(find_files(patterns=['**/1_sense/07_ã‚ªãƒãƒãƒ¥ãƒ‹ãƒ†ã‚£ä»®èª¬æŠ½å‡º/sense_opportunities.yaml']))}}",
        "{{read_files(find_files(patterns=['**/1_sense/06_ãƒªã‚µãƒ¼ãƒã‚µãƒãƒªãƒ¼ï¼ˆå…¨ä½“ï¼‰/draft_research_summary.md']))}}",
        "{{read_files(find_files(patterns=['**/focus_product_definition.md','**/focus_positioning_statement.md']))}}",
        "{{read_files(find_files(patterns=['**/1_sense/02_é¡§å®¢èª¿æŸ»/sense_customer_research.md']))}}",
        "{{read_files(find_files(patterns=['**/03_ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒƒãƒ—/solution_map.yaml']))}}"
      ]
      instructions: |
        Sense/Focusã¨ç¢ºå®šæ¸ˆã¿ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã€PRâ†’SLâ†’STã®å€™è£œã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆAs/I want/So thatï¼‰ã€å—ã‘å…¥ã‚ŒåŸºæº–ã®é››å½¢ã€æ¨å¥¨ãƒªãƒªãƒ¼ã‚¹ï¼ˆMVP/Release1ï¼‰ã‚’æŠ½å‡ºã—ã€JSON1ä»¶ã§è¿”ã—ã¦ãã ã•ã„ã€‚
        keys:
          st1_summary_hint, st1_ac_hint, st1_release_hint,
          st2_summary_hint, st2_ac_hint, st2_release_hint,
          st3_summary_hint, st3_ac_hint, st3_release_hint
      store_as: "sense_focus"
    - name: "prefill_from_yaml"
      action: "display"
      content: |
        ğŸ” å€™è£œï¼ˆè‡ªå‹•æŠ½å‡ºï¼‰
        {{auto_story_hints}}
        
        ğŸ” Sense/Focus ç”±æ¥ã®å€™è£œ
        - ST1: {{sense_focus.st1_summary_hint}} / AC: {{sense_focus.st1_ac_hint}} / ãƒªãƒªãƒ¼ã‚¹: {{sense_focus.st1_release_hint}}
        - ST2: {{sense_focus.st2_summary_hint}} / AC: {{sense_focus.st2_ac_hint}} / ãƒªãƒªãƒ¼ã‚¹: {{sense_focus.st2_release_hint}}
        - ST3: {{sense_focus.st3_summary_hint}} / AC: {{sense_focus.st3_ac_hint}} / ãƒªãƒªãƒ¼ã‚¹: {{sense_focus.st3_release_hint}}
    
    - name: "show_story_examples"
      action: "display"
      content: |
        ğŸ“ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ›¸å¼
        As a [èª°ãŒ], I want [ä½•ã‚’ã—ãŸã„], So that [ãªãœ/ä¾¡å€¤]
        ä¾‹: As a å…±åƒããƒãƒ, I want ã€Œä»Šã‚„ã‚‹1ã¤ã€ã ã‘ã‚’è¦‹ã‚‹, So that è¿·ã‚ãšç€æ‰‹ã§ãã‚‹
    
    - name: "collect_story_inputs"
      action: "ask_questions_with_template"
      template: |
        === PRé€£å‹•ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å…¥åŠ›ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ===
        1) PR1 â†’ ST1
        - ST1ï¼ˆAs/I want/So thatï¼‰
        ï¼ˆå€™è£œ: {{sense_focus.st1_summary_hint}}ï¼‰
        â†’
        - å—ã‘å…¥ã‚ŒåŸºæº–ï¼ˆç®‡æ¡æ›¸ãï¼‰
        ï¼ˆå€™è£œ: {{sense_focus.st1_ac_hint}}ï¼‰
        â†’
        - ãƒªãƒªãƒ¼ã‚¹ï¼ˆMVP/Release1ï¼‰
        ï¼ˆå€™è£œ: {{sense_focus.st1_release_hint}}ï¼‰
        â†’
        
        2) PR2 â†’ ST2
        - ST2ï¼ˆAs/I want/So thatï¼‰
        ï¼ˆå€™è£œ: {{sense_focus.st2_summary_hint}}ï¼‰
        â†’
        - å—ã‘å…¥ã‚ŒåŸºæº–
        ï¼ˆå€™è£œ: {{sense_focus.st2_ac_hint}}ï¼‰
        â†’
        - ãƒªãƒªãƒ¼ã‚¹ï¼ˆMVP/Release1ï¼‰
        ï¼ˆå€™è£œ: {{sense_focus.st2_release_hint}}ï¼‰
        â†’
        
        3) PR3 â†’ ST3
        - ST3ï¼ˆAs/I want/So thatï¼‰
        ï¼ˆå€™è£œ: {{sense_focus.st3_summary_hint}}ï¼‰
        â†’
        - å—ã‘å…¥ã‚ŒåŸºæº–
        ï¼ˆå€™è£œ: {{sense_focus.st3_ac_hint}}ï¼‰
        â†’
        - ãƒªãƒªãƒ¼ã‚¹ï¼ˆMVP/Release1ï¼‰
        ï¼ˆå€™è£œ: {{sense_focus.st3_release_hint}}ï¼‰
        â†’
        
        4) å®Ÿè£…é †åºï¼ˆä»»æ„ã€‚ä¾‹: ST1â†’ST2â†’ST3ï¼‰
        â†’
        =====================================
    
    - name: "wait_inputs"
      action: "wait_for_all_answers"
    
    # ã“ã“ã‹ã‚‰ï¼šViewerå¯¾å¿œã®çµ±åˆYAML + æ—¢å­˜ã®ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£YAMLã‚’ç”Ÿæˆ
    - name: "export_viewer_integrated_yaml"
      action: "create_markdown_file"
      path: "Flow/{{today}}/{{flow_dir}}/04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/viewer_story_map.yaml"
      content: |
        integrated_story_map:
          meta:
            project_name: {{project_name | default:"Untitled Project"}}
          version_definitions:
            order: [MVP, V1, V2]
          story_map_structure:
            activities:
              - id: ACT-ONBOARD
                name: Onboarding
              - id: ACT-TASKS
                name: Tasks
            backbones:
              - id: BB-SIGNUP
                name: Sign up
                sequence: 1
                activity_id: ACT-ONBOARD
              - id: BB-FLOW
                name: Create Task
                sequence: 2
                activity_id: ACT-TASKS
          display_order:
            backbones: [BB-SIGNUP, BB-FLOW]
          personas_stories:
            P001:
              name: ä¸»è¦ãƒšãƒ«ã‚½ãƒŠ
              stories:
                - id: ST-001
                  story: {{st1_summary | default:"I want to register"}}
                  backbone_id: BB-SIGNUP
                  version: MVP
                  status: TODO
                  backbone_x_version_sort: 1
                - id: ST-002
                  story: {{st2_summary | default:"I want to login"}}
                  backbone_id: BB-SIGNUP
                  version: MVP
                  status: TODO
                  backbone_x_version_sort: 2
            P002:
              name: ã‚»ã‚«ãƒ³ãƒ€ãƒª
              stories:
                - id: ST-003
                  story: {{st3_summary | default:"I want to create a task"}}
                  backbone_id: BB-FLOW
                  version: V1
                  status: TODO
                  backbone_x_version_sort: 1
          cross_persona_stories:
            - id: ST-004
              story: I want to see dashboard
              backbone_id: BB-FLOW
              version: V2
              status: TODO
              backbone_x_version_sort: 2
          story_mapping:
            ST-001: { backbone_id: BB-SIGNUP, sequence: 1 }
            ST-002: { backbone_id: BB-SIGNUP, sequence: 2 }
            ST-003: { backbone_id: BB-FLOW, sequence: 1 }
            ST-004: { backbone_id: BB-FLOW, sequence: 2 }

    # æ—¢å­˜ã®ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£è¡¨ç¾ï¼ˆProblem/Linksï¼‰ã¯ç¶­æŒ
    - name: "auto_propose_story_map_yaml"
      action: "create_markdown_file"
      path: "Flow/{{today}}/{{flow_dir}}/04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/story_map_proposed.yaml"
      content: |
        story_map:
          persona_ref: {{persona_id | default:"P001"}}
          problem_refs: [PR1, PR2, PR3]
          links:
            - chain: [A101, PR1, SL1, ST1]
            - chain: [A201, PR2, SL2, ST2]
            - chain: [A301, PR3, SL3, ST3]
          stories:
            - id: ST1
              summary: {{st1_summary}}
              acceptance: [{{st1_ac_1}}, {{st1_ac_2}}, {{st1_ac_3}}]
              release: {{st1_release | default:"MVP"}}
              links: [PR1, SL1, A101]
            - id: ST2
              summary: {{st2_summary}}
              acceptance: [{{st2_ac_1}}, {{st2_ac_2}}, {{st2_ac_3}}]
              release: {{st2_release | default:"MVP"}}
              links: [PR2, SL2, A201]
            - id: ST3
              summary: {{st3_summary}}
              acceptance: [{{st3_ac_1}}, {{st3_ac_2}}, {{st3_ac_3}}]
              release: {{st3_release | default:"Release1"}}
              links: [PR3, SL3, A301]
          releases:
            - name: MVP
              includes: [ST1, ST2]
            - name: Release1
              includes: [ST3]
          numbering_policy:
            - prefix: ST=Story

    - name: "auto_propose_story_map_mermaid"
      action: "create_markdown_file"
      path: "Flow/{{today}}/{{flow_dir}}/04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/story_map_proposed_mermaid.md"
      content: |
        ```mermaid
        flowchart LR
          A101:::action --> PR1:::problem --> SL1:::solution --> ST1[ST1]:::story
          A201:::action --> PR2:::problem --> SL2:::solution --> ST2[ST2]:::story
          A301:::action --> PR3:::problem --> SL3:::solution --> ST3[ST3]:::story
          classDef action fill:#fff3e0
          classDef problem fill:#ffebee
          classDef solution fill:#e8f5e8
          classDef story fill:#e3f2fd
        ```

    - name: "display_proposal"
      action: "display"
      content: |
        âœï¸ è‡ªå‹•ææ¡ˆã‚’ `viewer_story_map.yaml` / `story_map_proposed.yaml` / `story_map_proposed_mermaid.md` ã«å‡ºåŠ›ã—ã¾ã—ãŸã€‚ä¿®æ­£äº‹é …ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºæ¬„ã¯æ¡ç”¨ï¼‰ã€‚

    - name: "collect_story_corrections"
      action: "ask_questions_with_template"
      template: |
        === ä¿®æ­£ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆç©ºæ¬„ã¯æ¡ç”¨ï¼‰ ===
        ST1 è¦ç´„/AC/ãƒªãƒªãƒ¼ã‚¹/ãƒªãƒ³ã‚¯ï¼ˆä¾‹: PR1,SL1,A101ï¼‰
        â†’
        ST2 è¦ç´„/AC/ãƒªãƒªãƒ¼ã‚¹/ãƒªãƒ³ã‚¯
        â†’
        ST3 è¦ç´„/AC/ãƒªãƒªãƒ¼ã‚¹/ãƒªãƒ³ã‚¯
        â†’
        å®Ÿè£…é †åºï¼ˆä»»æ„ï¼‰ï¼š
        â†’
        =====================================

    - name: "confirm_generate"
      action: "confirm"
      message: "ææ¡ˆï¼‹ä¿®æ­£å†…å®¹ã§æœ€çµ‚æˆæœç‰©ï¼ˆviewer_story_map.yaml / story_map_todo.md / story_map.yaml / story_map_mermaid.mdï¼‰ã‚’ç”Ÿæˆã—ã€æ¤œè¨¼ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"

    # Vieweräº’æ›ã®æœ€çµ‚YAMLï¼ˆä¸Šæ›¸ãï¼‰
    - name: "export_viewer_integrated_yaml_final"
      action: "create_markdown_file"
      path: "Flow/{{today}}/{{flow_dir}}/04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/viewer_story_map.yaml"
      content: |
        integrated_story_map:
          meta:
            project_name: {{project_name | default:"Untitled Project"}}
          version_definitions:
            order: [MVP, V1, V2]
          story_map_structure:
            activities:
              - id: ACT-ONBOARD
                name: Onboarding
              - id: ACT-TASKS
                name: Tasks
            backbones:
              - id: BB-SIGNUP
                name: Sign up
                sequence: 1
                activity_id: ACT-ONBOARD
              - id: BB-FLOW
                name: Create Task
                sequence: 2
                activity_id: ACT-TASKS
          display_order:
            backbones: [BB-SIGNUP, BB-FLOW]
          personas_stories:
            P001:
              name: ä¸»è¦ãƒšãƒ«ã‚½ãƒŠ
              stories:
                - id: ST-001
                  story: {{st1_summary | default:"I want to register"}}
                  backbone_id: BB-SIGNUP
                  version: MVP
                  status: TODO
                  backbone_x_version_sort: 1
                - id: ST-002
                  story: {{st2_summary | default:"I want to login"}}
                  backbone_id: BB-SIGNUP
                  version: MVP
                  status: TODO
                  backbone_x_version_sort: 2
            P002:
              name: ã‚»ã‚«ãƒ³ãƒ€ãƒª
              stories:
                - id: ST-003
                  story: {{st3_summary | default:"I want to create a task"}}
                  backbone_id: BB-FLOW
                  version: V1
                  status: TODO
                  backbone_x_version_sort: 1
          cross_persona_stories:
            - id: ST-004
              story: I want to see dashboard
              backbone_id: BB-FLOW
              version: V2
              status: TODO
              backbone_x_version_sort: 2
          story_mapping:
            ST-001: { backbone_id: BB-SIGNUP, sequence: 1 }
            ST-002: { backbone_id: BB-SIGNUP, sequence: 2 }
            ST-003: { backbone_id: BB-FLOW, sequence: 1 }
            ST-004: { backbone_id: BB-FLOW, sequence: 2 }

    # === æ¤œè¨¼ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆSchemaValidator.js ã‚’ä½¿ç”¨ï¼‰ ===
    - name: "validate_viewer_yaml"
      action: "execute_shell"
      command: |
        node -e "(async()=>{const fs=require('fs');const yaml=require('js-yaml');const path=require('path');const {default:Validator}=await import('file:///Users/daisukemiyata/aipm_v3/Stock/programs/Tools/projects/story_map_viewer/modules/SchemaValidator.js');const p=process.argv[2];const text=fs.readFileSync(p,'utf-8');const data=yaml.load(text);const errs=Validator.validate(data);console.log(JSON.stringify({errors:errs},null,2));process.exit(0);})( )" Flow/{{today}}/{{flow_dir}}/04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/viewer_story_map.yaml | cat
      message: "Viewerç”¨YAMLã®ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼ã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°è¡¨ç¤ºã—ã¾ã™ï¼‰"

    - name: "generate_story_map_md"
      action: "create_markdown_file"
      path: "Flow/{{today}}/{{flow_dir}}/04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/story_map_todo.md"
      content: |
        # ã‚¢ãƒ—ãƒª MVPã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—
        
        ## å„ªå…ˆåº¦é †ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆPRé€£å‹•ï¼‰
        1. {{st1_summary}}ï¼ˆå—ã‘å…¥ã‚ŒåŸºæº–: {{st1_ac_1}} / {{st1_ac_2}} / {{st1_ac_3}}ã€ãƒªãƒªãƒ¼ã‚¹: {{st1_release | default:"MVP"}}ï¼‰
        2. {{st2_summary}}ï¼ˆå—ã‘å…¥ã‚ŒåŸºæº–: {{st2_ac_1}} / {{st2_ac_2}} / {{st2_ac_3}}ã€ãƒªãƒªãƒ¼ã‚¹: {{st2_release | default:"MVP"}}ï¼‰
        3. {{st3_summary}}ï¼ˆå—ã‘å…¥ã‚ŒåŸºæº–: {{st3_ac_1}} / {{st3_ac_2}} / {{st3_ac_3}}ã€ãƒªãƒªãƒ¼ã‚¹: {{st3_release | default:"Release1"}}ï¼‰
        
        ## å®Ÿè£…é †åº
        {{impl_order | default:"ST1â†’ST2â†’ST3"}}

    - name: "export_story_map_yaml"
      action: "create_markdown_file"
      path: "Flow/{{today}}/{{flow_dir}}/04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/story_map.yaml"
      content: |
        story_map:
          persona_ref: {{persona_id | default:"P001"}}
          problem_refs: [PR1, PR2, PR3]
          links:
            - chain: [A101, PR1, SL1, ST1]
            - chain: [A201, PR2, SL2, ST2]
            - chain: [A301, PR3, SL3, ST3]
          stories:
            - id: ST1
              summary: {{st1_summary}}
              acceptance: [{{st1_ac_1}}, {{st1_ac_2}}, {{st1_ac_3}}]
              release: {{st1_release | default:"MVP"}}
              links: [PR1, SL1, A101]
            - id: ST2
              summary: {{st2_summary}}
              acceptance: [{{st2_ac_1}}, {{st2_ac_2}}, {{st2_ac_3}}]
              release: {{st2_release | default:"MVP"}}
              links: [PR2, SL2, A201]
            - id: ST3
              summary: {{st3_summary}}
              acceptance: [{{st3_ac_1}}, {{st3_ac_2}}, {{st3_ac_3}}]
              release: {{st3_release | default:"Release1"}}
              links: [PR3, SL3, A301]
          releases:
            - name: MVP
              includes: [ST1, ST2]
            - name: Release1
              includes: [ST3]
          numbering_policy:
            - prefix: ST=Story

    - name: "export_story_map_mermaid"
      action: "create_markdown_file"
      path: "Flow/{{today}}/{{flow_dir}}/04_ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒƒãƒ—/story_map_mermaid.md"
      content: |
        ```mermaid
        flowchart LR
          A101:::action --> PR1:::problem --> SL1:::solution --> ST1[ST1]:::story
          A201:::action --> PR2:::problem --> SL2:::solution --> ST2[ST2]:::story
          A301:::action --> PR3:::problem --> SL3:::solution --> ST3[ST3]:::story
          classDef action fill:#fff3e0
          classDef problem fill:#ffebee
          classDef solution fill:#e8f5e8
          classDef story fill:#e3f2fd
        ```

    - name: "notify_completion"
      action: "display"
      content: |
        âœ… ç”Ÿæˆã—ã¾ã—ãŸï¼š
        - viewer_story_map.yamlï¼ˆViewerå¯¾å¿œï¼‰
        - story_map_proposed.yaml / story_map_proposed_mermaid.mdï¼ˆãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ç”¨ï¼‰
        - story_map_todo.md / story_map.yaml / story_map_mermaid.md
```

## æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰
â†’ `ä»®èª¬é§†å‹•_UIãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ` ã§ç”»é¢è¨­è¨ˆã¸
